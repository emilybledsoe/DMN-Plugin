{"version":3,"sources":["../../../src/features/drag-and-drop/DragAndDrop.js"],"names":["Row","Col","closest","domClosest","event","domEvent","TARGET_SELECTOR","DragAndDrop","eventBus","renderer","modeling","sheet","stopEvent","targetEl","target","cellEl","allowed","hoverEl","_dragContext","_emit","dataTransfer","dropEffect","draggedElement","_sheet","getRoot","rows","index","indexOf","_modeling","moveRow","cols","moveCol","handleDragEnd","_unbindListeners","_eventBus","_renderer","on","bind","document","handleDragOver","handleDrop","unbind","eventName","originalEvent","fire","dragContext","element","effectAllowed","setData","_bindListeners","$inject","preventDefault","stopPropagation"],"mappings":"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","sourcesContent":["import { Row, Col } from '../../model';\r\n\r\nimport {\r\n  closest as domClosest,\r\n  event as domEvent\r\n} from 'min-dom';\r\n\r\nconst TARGET_SELECTOR =\r\n  `.dmn-decision-table-container td,\r\n   .dmn-decision-table-container th`;\r\n\r\nexport default class DragAndDrop {\r\n  constructor(eventBus, renderer, modeling, sheet) {\r\n    this._eventBus = eventBus;\r\n    this._renderer = renderer;\r\n    this._modeling = modeling;\r\n    this._sheet = sheet;\r\n\r\n    this._dragContext = null;\r\n\r\n    eventBus.on('table.destroy', () => {\r\n      this._unbindListeners();\r\n    });\r\n  }\r\n\r\n  _bindListeners() {\r\n    domEvent.bind(document, 'dragover', this.handleDragOver);\r\n    domEvent.bind(document, 'drop', this.handleDrop);\r\n    domEvent.bind(document, 'dragend', this.handleDragEnd);\r\n  }\r\n\r\n  _unbindListeners() {\r\n    domEvent.unbind(document, 'dragover', this.handleDragOver);\r\n    domEvent.unbind(document, 'drop', this.handleDrop);\r\n    domEvent.unbind(document, 'dragend', this.handleDragEnd);\r\n  }\r\n\r\n  _emit(eventName, originalEvent) {\r\n\r\n    return this._eventBus.fire(eventName, {\r\n      dragContext: this._dragContext,\r\n      originalEvent\r\n    });\r\n  }\r\n\r\n  startDrag(element, event) {\r\n\r\n    stopEvent(event, true);\r\n\r\n    event.dataTransfer.effectAllowed = 'move';\r\n\r\n    // QUIRK: Firefox won't fire events unless data was set\r\n    if (event.dataTransfer.setData) {\r\n      event.dataTransfer.setData('text', '__DUMMY');\r\n    }\r\n\r\n    this._dragContext = {\r\n      draggedElement: element\r\n    };\r\n\r\n    this._bindListeners();\r\n\r\n    this._emit('dragAndDrop.dragStart', event);\r\n  }\r\n\r\n  handleDragOver = (event) => {\r\n\r\n    // we're taking over (!)\r\n    stopEvent(event);\r\n\r\n    const targetEl = event.target;\r\n\r\n    const cellEl = domClosest(targetEl, TARGET_SELECTOR, true);\r\n\r\n    let allowed = !!cellEl;\r\n\r\n    const {\r\n      hoverEl\r\n    } = this._dragContext;\r\n\r\n    // drag leave\r\n    if (hoverEl && hoverEl !== cellEl) {\r\n      this._emit('dragAndDrop.dragLeave', event);\r\n\r\n      // unset target element\r\n      this._dragContext.targetEl = null;\r\n\r\n      // unset hover element\r\n      this._dragContext.hoverEl = null;\r\n    }\r\n\r\n    if (cellEl) {\r\n\r\n      // drag enter\r\n      if (cellEl !== hoverEl) {\r\n\r\n        // new hover element\r\n        this._dragContext.hoverEl = cellEl;\r\n\r\n        allowed = this._emit('dragAndDrop.dragEnter', event);\r\n\r\n        if (allowed !== false) {\r\n          // new targetEl\r\n          this._dragContext.targetEl = cellEl;\r\n        }\r\n      }\r\n\r\n      // drag over\r\n      allowed = this._emit('dragAndDrop.dragOver', event);\r\n    }\r\n\r\n    event.dataTransfer.dropEffect = allowed !== false ? 'move' : 'none';\r\n  }\r\n\r\n  handleDrop = (event) => {\r\n\r\n    // prevent default drop action\r\n    // QUIRK: Firefox will redirect if not prevented\r\n    stopEvent(event);\r\n\r\n    const target = this._emit('dragAndDrop.drop', event);\r\n\r\n    if (target) {\r\n\r\n      const {\r\n        draggedElement\r\n      } = this._dragContext;\r\n\r\n      if (draggedElement instanceof Row) {\r\n        const { rows } = this._sheet.getRoot();\r\n\r\n        let index = rows.indexOf(target);\r\n\r\n        this._modeling.moveRow(draggedElement, index);\r\n      } else if (draggedElement instanceof Col) {\r\n        const { cols } = this._sheet.getRoot();\r\n\r\n        let index = cols.indexOf(target);\r\n\r\n        this._modeling.moveCol(draggedElement, index);\r\n      }\r\n    }\r\n\r\n    // manually call to drag end needed, as we prevent the default\r\n    // browser behavior / drag end handling via\r\n    // event.preventDefault();\r\n    this.handleDragEnd(event);\r\n  }\r\n\r\n  handleDragEnd = (event) => {\r\n\r\n    // prevent default drop action\r\n    stopEvent(event);\r\n\r\n    this._unbindListeners();\r\n    this._emit('dragAndDrop.dragEnd', event);\r\n\r\n    this._dragContext = null;\r\n  }\r\n\r\n}\r\n\r\nDragAndDrop.$inject = [\r\n  'eventBus',\r\n  'renderer',\r\n  'modeling',\r\n  'sheet'\r\n];\r\n\r\n\r\n\r\n// helpers /////////////////\r\n\r\nfunction stopEvent(event, preventDefault) {\r\n  event.stopPropagation();\r\n\r\n  if (preventDefault !== true) {\r\n    event.preventDefault();\r\n  }\r\n}"],"file":"DragAndDrop.js"}